### Дерево проекта
```bash
.
├── app
│   ├── api_event
│   │   └── api_kuda_go.py
│   ├── api_telegram
│   └── main.py
├── pyproject.toml
├── README.md
├── reports
│   ├── record_001.md
│   └── договорённости по задаче
└── uv.lock
```
### Что изменилось
В директорию `app/api_event` добавил модуль `api_kuda_go.py`.
В нем реализовал три вспомогательные, пять функций взаимодействующих с [апи](https://docs.kudago.com/api) kauda go и одна функция, которая использует все предыдущие, чтобы собрать данные для отправки.

#### Вспомогательные функции
- to_unixtime() - функция берёт текущее время, приводит его к стандартному виду и преобразует в формат Unix timestamp — число секунд с начала эпохи Unix. (время как целое число 123456) 
- to_datetime(unixtime: int) - функция принимает аргумент целое число, которое нужно преобразовать в понятную для человека дату и время, результат возвращается в виде строки в вормате `2025-11-21 12:12:25`
- date_event(dates: list) - функция приниммает список дат начало и конец события в формате unixtime, обрабатыват список и сохраняет в строку даты которые >= текущей даты. Пока что сохраняем в строку, возможно если это будет не удобно, можно будет сохранять так же в список или другую структуру данных.
#### Функции, которые взаимодействуют с апи
- get_events() - возвращает словарь с даами по мероприятиям от текущей даты.
- get_collections() - функция возвращает словарь с подборкой рекомендации от текущей даты.
- get_movie_list() - функция возвращает список словарей в колличестве трёх штук, где есть описание фильма, его название, дата публикации и ссылка на постер. 
- get_news() - функция взвращеает словарь с данными, что интересного/знаменатиельно в текущую дату.
- get_places(place_id: int|None) - функция `get_event` в итоговом словаре имеет ключ `place`, который содержит в себе id (идентификатор) места, данная функция примает аргумент идентификатор места `place_id` (целое число) или `None`, если значение `place` пустое. По этому идентификатору функция получает по апи адрес и название места и возвращает эти данные в словаре.
#### Основная функция модуля
- collect_data_for_sending() - Функция собирает список с данными по новостям, кино, мероприятиям и возвращет список словарей с полученными данными. Каждый словарь с каким либо из событий имеет приимерно одинаковый набор полей, котрый можно будеть использовать как шаблон для отправки сообщения.
```text
"title" - заголовок
"description" - описание
"publication_date" - дата публикации
"place" - адрес, название места
"price" - стоимость
"image" - афиша
"dates" - даты проведения
```
### Структура модуля
1. Импорт библиотек.

```python
import os
import time
import requests

from dotenv import load_dotenv
from datetime import datetime

load_dotenv()
```
Пример `import dotenv` - импортирует(подключает) весь модуль `dotenv`, к методам и функциям данного модуля можно обратиться через точку(.), чтоюбы вызвать функцию используется конструкция `dotenv.load_dotenv()`

Пример `from dotenv import load_dotenv` - тут сразу из модуля `dotenv` импортируем только одину функцию, а не весь модуль. Для вызова теперь можно использвоать просто функцию `load_dotenv()`

2. Добавление констант (постоянные значения, кооторые не меняются)
```pyton
URL = os.getenv("url_kuda_go")
API_VERSION = os.getenv("api_version")
DATETIME_FORMAT = "%Y-%m-%d %H:%M:%S"
URL_FOR_REQUEST = f"{URL}/{API_VERSION}"
```
>В проекте есть файл `.env`, в котором храняться чувствительные данные, в том числе храним там данные по апи
>
>Сейчас он выглядит так:
>```pyton
>url_kuda_go = https://kudago.com/public-api
>api_version = v1.4
>```
>Константы `URL` и `API_VERSION` берут данные именно оттуда.
>А `os.getenv` загружает эти данные

3. Функции
>Необольшой разбор функций 
```python
def get_events() -> dict: 
    """Получить список мероприятий 
    Returns:
        dict: Возвращается словарь 
        в котором есть ключ results, это список
        словарей с событиями
        {
    "count": 82677,
    "next": "https://kudago.com/public-api/v1.2/events/?fields=age_restriction%2Cis_free&page=2",
    "previous": null,
    "results": [
        {
            "age_restriction": "18+",
            "is_free": false
        },
        ...
    ]
}
    """
    param = {  
            "page": 1,
            "page_size": 5,
            "fields": "images,dates,title,place,description,price,publication_date",
            "location": "spb",
            "actual_since": to_unixtime(),
            "text_format":"text"
            }
    url = f"{URL_FOR_REQUEST}/events"
    response = requests.get(url, params=param)
    return response.json()
```
- `def get_events() -> dict:` - объявление функции, `def` ключевое слово от defenition (определение), `get_events` имя функции, `()` если функция принимает аргументы, то в скобках определяется имя аргумента и его тип. 
Конструкция `-> dict` определяет, какой тип данных возвращает функция. В данном случае это словарь. Если функция ничего не возвращает, то тогда конструкция не пишется.
- В кавычках под определением функции """многострочый комментарий""", для функции это своего рода документация, помогает не вчитываясь в код функции понять, для чего она предназначена, какие аргументы прингимает, что возвращает.
- `param` - переменная, которая содержит параметры для http запроска к серверу kuda go, записывается в фигурных скобках в формате `"ключ": "значение"`. Какие сюда можно вписывать параметры подскажет документация АПИ. Для каждого запроса свой набор параметров.
- `url = f"{URL_FOR_REQUEST}/events"` - переменная которая содержит строку шаблон с адресом к апи kuda go, конкретно к списку мероприятий. Константа `URL_FOR_REQUEST` слодержит значение `https://kudago.com/public-api/v1.4`
- `response = requests.get(url, params=param)` - переменная response содержит HTTP GET запрос к адресу с определёнными параметрами. Функция `requests.get` выполняет запрос в скобках функция примнимает аргументы `url, params=param` урл и параметры, результат этого запроса сохраняется в переменной `response` с которым можно джальше работать. 
Запрос выглядит следующим образом `https://kudago.com/public-api/v1.4/events/?page=1&page_size=5&fields=images%2Cdates%2Ctitle%2Cplace%2Cdescription%2Cprice%2Cpublication_date&location=spb&actual_since=1764143343&text_format=text` , если скопировать этот запрос в адресную строку браузера, то получим результат
<img width="1556" height="464" alt="изображение" src="https://github.com/user-attachments/assets/f83adc68-db65-4174-98f7-e7b6f7f1ddea" />

- `return response.json()` - `return` ключевое слово, возвращаем данные в формате `json()` для python в этом случае есть возможность работать с этими данными как со словарём т.к. структура одинаковая.

>**Остальные функции работающие с апи одинаковые, просто возвращают разные значения**
---
```python
def to_unixtime() -> int:
    """Получить текущее время в unixtime формате.
    Returns:
        int: 1763715782 unixtime формат, целое число 
    """
    return int(time.mktime(datetime.now().timetuple()))
```
- функция состоит из одной строки, которая возвращачет текущцю дату время в формате целого числа.
- Т.к. апи понимает дату и время в unixtime, это популярный формат, всего лишь целое число. Это позволяет избежать ошибок.
- Одной строке происходит три действия
  - `datetime.now()` получаем дату и время `2025-11-26 12:06:08.310871` в формате datetime, приводим его к структуре кортеж `time.struct_time(tm_year=2025, tm_mon=11, tm_mday=26, tm_hour=12, tm_min=6, tm_sec=8, tm_wday=2, tm_yday=330, tm_isdst=-1)` с помощью `.timetuple()`
  - `time.mktime()` - собирает данные из кортежа и преобразует их в число с плавающей точкой `1764147968.0`
  - `int()` - приводеит это число к целому т.е. отбрасывает запятую и всё что после неё, получаем результат `1764147968`
---
```python
def to_datetime(unixtime: int) -> str:
    """Преобразовать unixtime в datetime.
    Returns:
        str: возвращается строка вормате "2025-11-21 12:12:25" 
    """
    return str(datetime.fromtimestamp(unixtime))
```
- Тут преобразуем дату в фомате числа `1764147968` в дату формате текст `2025-11-26 12:30`
- `datetime.fromtimestamp(unixtime)` - преобразует целое число в формат datetime `2025-11-26 12:06:08`
- `str()` - приводит результат к строке (тип строка)
---
```python
def date_event(dates: list):
    result = ""
    for i in dates:
        start = to_datetime(i.get("start"))
        end = to_datetime(i.get("end"))
        if i.get("start") < to_unixtime():
            continue
        result += f"С {start} по {end}\n"
    return result
```
- Функция принимает список словарей с датами в формате чисел, пример:
```python
[
{'end': 1622448000, 'start': 1618732800},
{'end': 1633593600, 'start': 1633593600},
{'end': 1633692600, 'start': 1633692600},
...
]
```
- Создаём переменную `result` со значением пустая строка `""`
- `for i in dates:` - запускаем цикл по полученному списку `dates`, переменной `i` будет присваиваться словарь, в первой итерации `i = {'end': 1622448000, 'start': 1618732800}`, во второй итерации `i = {'end': 1633593600, 'start': 1633593600}` и т.д. до последнего словаря в списке `dates`
- `start = to_datetime(i.get("start"))` - Конструкция `i.get('start')` извлекает из словаря по ключу `start` его значение, это значение мы отдаём в вспомогательную функцию `to_datetime()`, которая преобразует число в дату в флоате строка, результат присваеваем в переменную `start`
- Тоже самое с переменной `end`
- `if i.get("start") < to_unixtime(): continue` - блок ветвления, если время в формате число из словаря меньше текущего времени в том же формате, тогда прервать операцияю с этим словарём и перейти к следующему элементу в списке `dates`, иначе продолжить (это сделано для того, чтобы были только свежие данные)
- `result += f"С {start} по {end}\n"` - результат присваиваем в переменную `result` путём операции конкатенации (сложение строк), для этого используем += чтобы избежать дублирования **result** `result = result + f"С {start} по {end}\n"`. `\n` - python понимает это выражение как перенос строки, обратный слэш экранирует буку `n`, чтобы её небыло видно в тексте, в итоге получится результат:
```python
С 2025-12-13 00:00:00 по 2026-01-12 00:00:00
С 2025-11-26 20:00:00 по 2025-11-26 20:00:00
```
>Возможно если строка не подойдёт, то будем сохранять в список. Посмотрим при реализации логики отправки сообщений.
---
```python
def collect_data_for_sending() -> list[dict]:
    """Подготовить данные для отправки
    Функция собирает список с данными по новостям, кино, мероприятиям
    Returns:
        list[dict]: список словарей
    """
    list_of_mesages = []
    # список мероприятий
    events = get_events().get("results")
    for event in events:
        try:
            place_id = event.get("place").get("id")
            place = get_places(place_id).get("results")[0]
        except (TypeError, AttributeError, IndexError):
            place = {}
        
        list_of_mesages.append(
                {
                    "title": event.get("title"),
                    "description": event.get("description"),
                    "publication_date": to_datetime(event.get("publication_date")),
                    "place": place,
                    "price": event.get("price"),
                    "image": event.get("images")[0].get("image"),
                    "dates": date_event(event.get("dates"))
                    }
                )
    # спсиок мероприятий
    collections = get_collections().get("results")
    for collect in collections:
        list_of_mesages.append(
                {
                    "title": collect.get("title"),
                    "publication_date": to_datetime(collect.get("publication_date")),
                    "site_url": collect.get("site_url")
                    }
                )

    # список фильмов
    movies = get_movie_list().get("results")
    for movie in movies:
        list_of_mesages.append(
                {
                    "title": movie.get("title"),
                    "description": movie.get("description"),
                    "publication_date": to_datetime(movie.get("publication_date")),
                    "image": movie.get("images")[0].get("image"),
                    }
                )
    # список новостей
    news = get_news().get("results")
    for tidings in news:
        list_of_mesages.append(
                {
                    "title": tidings.get("title"),
                    "description": tidings.get("description"),
                    "publication_date": to_datetime(tidings.get("publication_date")),
                    "image": tidings.get("images")[0].get("image"),
                    "site_url": tidings.get("site_url")
                    }
                )
    return list_of_mesages
```
- Создаём переменную с пустым списком `list_of_mesages`
- Создаём переменную, вызываем функцию с нужным событием и результат присваеваем этой переменной `news = get_news().get("results")`
- Далее в цикле проходим по всем элементам словаря, где есть даты публикаций в формате числа - преобразуем в читаемую дату в формате строки, где есть список дат мероприятий - так же преобразуем читаемый формат.
- Новый подготовленный словарь добавляем в список `list_of_mesages`
- И так прохом по каждой функции, фильмы, события, новости, мероприяти
- После функция возвращает список с этими данными, результат ниже, с этими данными мы и будем работать дальше
```python
[{'dates': 'С 2025-12-13 00:00:00 по 2026-01-12 00:00:00\n',
  'description': 'Новогодние и рождественские дни в Санкт-Петербурге — это '
                 'нарядные ёлки, декорации, иллюминация и, конечно же, '
                 'ярмарка. В этом году праздничные домики появятся сразу на '
                 'трёх площадях и будут работать с 13 декабря по 11 января.',
  'image': 'https://media.kudago.com/images/event/4d/30/4d30ea696ee39c6d3fd922be8d6cc018.jpg',
  'place': {},
  'price': '',
  'publication_date': '2025-10-31 11:33:59',
  'title': 'рождественская ярмарка'},
 {'dates': '',
  'description': 'Камерная экскурсия, которая оставит вас наедине с мыслями '
                 'ленинградцев в осаждённом городе. Прогулка построена на '
                 'основе записок и ценна тем, что воспоминаниями о блокаде '
                 'пережившие её люди делились неохотно. Начните экскурсию '
                 'тогда, когда будете готовы.',
  'image': 'https://media.kudago.com/images/event/b5/f8/b5f81286943a865cc5eac9a17e5914f2.jpg',
  'place': {'address': 'ул. Большая Зеленина, д. 12',
            'id': 3037,
            'title': 'Станция метро «Чкаловская»'},
  'price': '',
  'publication_date': '2024-01-22 16:06:48',
  'title': 'Аудиоэкскурсия «Блокада на Петроградской стороне с Софьей Лурье»'},
 {'dates': '',
  'description': 'Проведите время ярко и незабываемо, побалуйте себя тем, о '
                 'чём давно мечтали! Посетите художественный мастер-класс в '
                 'студиях Artista, и он подарит вам и вашим близким магию '
                 'творчества, новые впечатления и приятные воспоминания.',
  'image': 'https://media.kudago.com/images/event/f2/1b/f21b15dbad5f0a39e8d661c2ad23af00.jpg',
  'place': {'address': 'Тучков пер., д. 11/5',
            'id': 32323,
            'title': 'художественная студия Artista'},
  'price': 'от 2400 до 6480 рублей',
  'publication_date': '2019-02-04 15:21:45',
  'title': 'мастер-классы по живописи «Картина за 3 часа»'},
 {'dates': 'С 2025-11-26 20:00:00 по 2025-11-26 20:00:00\n',
  'description': 'Группа Settlers выступит в Петербурге с '
                 'концертом-перформансом «Лес» и презентует новый ЕР.',
  'image': 'https://media.kudago.com/images/event/4f/26/4f26400cf9851b769b93ed4839937c5f.jpg',
  'place': {},
  'price': 'от 1400 до 3200 рублей',
  'publication_date': '2023-05-04 12:52:00',
  'title': 'концерт группы Settlers'},
 {'dates': '',
  'description': 'Организаторы обещают открыть для вас те места, которые '
                 'раньше были закрыты для свободного посещения.',
  'image': 'https://media.kudago.com/images/event/45/ee/45ee0538c07302aa1eceba5bfae4fdf9.jpg',
  'place': {},
  'price': 'уточняйте на сайте',
  'publication_date': '2021-04-19 12:40:00',
  'title': 'Проект «Открытый город»'},
 {'publication_date': '2025-12-31 23:00:00',
  'site_url': 'https://kudago.com/all/list/samyie-ozhidaemyie-teatralnyie/',
  'title': 'Самые ожидаемые театральные фестивали 2025 года'},
 {'publication_date': '2025-11-30 05:00:10',
  'site_url': 'https://kudago.com/spb/list/glavnye-vystavki-spb/',
  'title': 'Главные выставки ноября в Петербурге'},
 {'description': 'Романтический отпуск на Лазурном побережье.',
  'image': 'https://media.kudago.com/images/movie/c9/fb/c9fb260c4c9f79c76cc57358e803df6a.jpg',
  'publication_date': '2014-12-04 18:02:14',
  'title': 'Бассейн'},
 {'description': 'Комедийный хоррор британского кинорежиссёра Эдгара Райта, '
                 'широкую известность которому принесли фильмы «Типа крутые '
                 'легавые» и «Скотт Пилигрим против всех».',
  'image': 'https://media.kudago.com/images/movie/b9/df/b9df77cc9cba1e51a3961fe8aa639b85.jpeg',
  'publication_date': '2015-11-06 11:52:49',
  'title': 'Зомби по имени Шон'},
 {'description': 'Анимационная сказка о дружбе, героизме и том, что даже самые '
                 'странные создания могут найти своё место.',
  'image': 'https://media.kudago.com/images/movie/99/0d/990dcbf37c87ab68807dfb493e2962bf.webp',
  'publication_date': '2025-11-20 16:36:45',
  'title': 'Стич-Хэд. Хранитель монстров'},
 {'description': 'Две трети пользователей онлайн-торговли называют инициативу '
                 'о запрете скидок на маркетплейсах несправедливой. Эти данные '
                 'представил аналитический центр, который изучил реакцию '
                 'покупателей на предложение банков ограничить акционные '
                 'механики при оплате через их карты. Респонденты считают идею '
                 'опасной для цен, конкуренции и малого бизнеса',
  'image': 'https://media.kudago.com/images/news/cf/9f/cf9faf40965a9d0e7b40971393db895c.jpg',
  'publication_date': '2025-11-26 13:10:09',
  'site_url': 'https://kudago.com/all/news/pokupateli-protiv-rossiyane/',
  'title': 'Покупатели против: россияне считают запрет скидок на маркетплейсах '
           'серьёзным ударом по кошельку'}]
```
---
## Работа с github
### Открыть файл
Чтобы открыть файл, нужно пройти в нужную директорию и кликнуть по файлу (выделил жёлтым)
<img width="1462" height="543" alt="изображение" src="https://github.com/user-attachments/assets/c51e60e0-8c90-45bd-bef7-8305daa11999" />

Результат
<img width="1841" height="611" alt="изображение" src="https://github.com/user-attachments/assets/89c03cff-7bc0-4ab2-b3a1-f05268b7906b" />

Чтобы посмотреть изменения, нужно кликнуть по кнопке с хэшем коммита, типа токго - `c8f23ac`, выделил жёлтым, это справа
<img width="1841" height="611" alt="изображение" src="https://github.com/user-attachments/assets/25faaaf4-8415-4e29-9810-82433c20cac0" />


Результат, плюсы (или зелёная заливка) и минусы (или красная заливкуа) укажут, что изменилось
<img width="1540" height="423" alt="изображение" src="https://github.com/user-attachments/assets/4e3d5395-b0cf-4fc8-8a3d-f0b94bd79bde" />
